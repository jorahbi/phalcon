#!/usr/bin/env php
<?php

define('APP_PATH', dirname(dirname(__DIR__)));
define('BASE_PATH', dirname(APP_PATH));
define('MODULE_PATH', APP_PATH . '/modules');

class CommandHelper
{
	const NAME = '';
	const VERSION = 'dev';

	protected static $di;
	protected static $app;

	public static function start()
	{
		self::loader();
		self::$app = new Symfony\Component\Console\Application(self::NAME, self::VERSION);
		self::addCommands();
		self::setService();
		self::$app->run();
		
	}

	private static function _getDi()
	{
		if(empty(self::$di))
		{
			self::$di = new \Phalcon\Di\FactoryDefault();
		}
		return self::$di;
	}

	public static function getService($serviceName)
	{
		return self::_getDi()->get($serviceName);
	}

	public static function setService()
	{
		$di = self::_getDi();

		$di->setShared('config', function () {
			return new \Phalcon\Config(require APP_PATH . '/common/config/config.php');
		});

		$di->setShared('commandDb', function () {
			$config = $this->get('config');
			$adapter = strtolower($config->database->adapter);
			return new \PDO(
				"{$adapter}:dbname={$config->database->dbname};host={$config->database->host}", 
				$config->database->username, 
				$config->database->password
			);
		});
		
	}

	protected static function loader()
	{
		$loader = new \Phalcon\Loader();
		$loader->registerFiles([
			BASE_PATH . '/vendor/autoload.php'
		]);

		$loader->registerNamespaces([
			'Common\\Config' => APP_PATH . '/common/config',
			'Core\\Bin\\Helper' => APP_PATH . '/core/bin/helper',
			'Core\\Bin\\Commands' => APP_PATH . '/core/bin/commands'
		]);
		$loader->register();
	}

	protected static function addCommands()
	{
		self::$app->addCommands([
			new \Core\Bin\Commands\SchemaCommand()
		]);
	}	
}

CommandHelper::start();
